<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        @import url('./air-freight.css');
    </style>
</head>

<body style="margin:0">
    <svg id="air-freight-map"></svg>

    <svg style='display:none;'>
        <!-- used for country borders -->
        <defs>
            <filter id="blur-effect" x="-50%" y="-50%" width="150%" height="150%">
                <feGaussianBlur in="SourceGraphic" stdDeviation=".6" />
            </filter>
        </defs>
    </svg>
    <script src="../../../build/eurostatmap.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="./regionLabels.js"></script>
    <script src="./regions.js"></script>
    <script>
        fetch('./airFreightGraph.json')
            .then(r => r.json())
            .then(graphData => {
                console.log('Loaded freight data:', graphData);
                const width = 1050
                const height = 710;

                const greys = ['#D3D3D3', '#A9A9A9', '#808080', '#696969', '#36454F']; // Light Gray, Dark Gray: #808080, Dim Gray: #696969, Charcoal: #36454F
                const fourColorTheorem = ["#2B6CB0", "#D69E2E", "#2F855A", "#C53030"];
                // const regionColors = {
                //     "north america": "#fbead7", // pale sand
                //     "central america and caribbean": "#fcf3d6", // light cream
                //     "south america": "#d8f0ea", // pale turquoise
                //     "north africa": "#fce2da", // warm blush
                //     "rest of africa": "#dee6ea", // misty blue-grey
                //     "western asia": "#fdeacc", // peach tint
                //     "southern asia": "#f9dede", // rose tint
                //     "central asia": "#fdf3d9", // pale yellow
                //     "eastern asia": "#e6f0ff", // pale lavender-blue (cooler)
                //     ASEAN: "#e0f8f0", // pale mint-green (warmer)
                //     "australasia, s.sea is. & antarctica": "#e5ecf0", // fog grey-blue
                //     EU: "#dde5f0", // very light slate
                //     "europe except eu": "#E8EEFA", // faint blue-grey
                //     "eastern africa": "#E6F4EA"
                // }
                const regionColors = {
                    "north america": fourColorTheorem[0],
                    "central america and caribbean": fourColorTheorem[1],
                    "south america": fourColorTheorem[2],
                    "north africa": fourColorTheorem[3],
                    "rest of africa": fourColorTheorem[0],
                    "western asia": fourColorTheorem[1],
                    "southern asia": fourColorTheorem[2],
                    "central asia": "#dde5f0",
                    "eastern asia": fourColorTheorem[0],
                    ASEAN: fourColorTheorem[1],
                    "australasia, s.sea is. & antarctica": fourColorTheorem[2],
                    EU: fourColorTheorem[0],
                    "europe except eu": fourColorTheorem[3],
                    "eastern africa": fourColorTheorem[0]
                }


                const worldProjection = d3
                    .geoAzimuthalEquidistant()
                    .rotate([0, 0])
                    .scale(200)
                    .translate([width / 2.4, width / 2.3])

                const valuesLabelFormatter = (d) => d3.format('.2s')(d * 1000)

                const breaks = [-20, -10, -5, 0, 5];

                const reds = ['#fee5d9', '#fcae91', '#fb6a4a', '#cb181d']
                const colors = [
                    reds[3], // strong red (large negative)
                    reds[2], // medium red
                    reds[1], // light red
                    reds[0], // pale red
                    "#67a9cf", // medium blue
                    "#2166ac"  // strong blue (large positive)
                ];

                const colorFunction = d3.scaleThreshold()
                    .domain(breaks)   // ascending thresholds
                    .range(colors);   // length = breaks.length + 1

                function parseChangeToPct(v) {
                    if (v == null) return NaN;
                    const s = String(v).trim();
                    const hasPct = s.includes('%');
                    let n = parseFloat(s.replace('%', ''));
                    if (!hasPct && Math.abs(n) <= 1) n *= 100; // interpret small decimals as fractions
                    return n;
                }

                const spaceAsThousandSeparator = function (number) {
                    return number.toLocaleString('en').replace(/,/gi, ' ')
                }
                const tooltipFunction = function (link, map) {
                    const buf = []
                    const statData = map.statData()
                    const unit = statData.unitText() || ''

                    // Header with region name and ID
                    const title = `${link.source.name || link.source.id} to ${link.target.name || link.target.id}`
                    buf.push(`
                        <div class="em-tooltip-bar">
                            <b>${title}</b>
                        </div>
                    `)

                    // Value
                    buf.push(`<div class='em-tooltip-text'>
                        <table class="em-tooltip-table">
                            <tbody>
                                <tr><td>${spaceAsThousandSeparator(link.value * 1000)} tonnes</td></tr>
                                <tr><td>Change: ${link.target.change}</td></tr>
                            </tbody>
                        </table> 
                    </div>`)

                    return buf.join('')
                }

                const map = eurostatmap
                    .map("flow")
                    .svgId("air-freight-map")
                    .width(width)
                    .height(height)
                    .title("Air freight")
                    .subtitle(
                        "Transport of freight and mail from the EU to outside the EU, 2023"
                    )

                    //projection
                    .projectionFunction(worldProjection)

                    //geometries
                    .geo("WORLD")
                    .proj("4326")
                    .scale("60M")

                    // flow settings
                    .flowGraph(graphData)
                    .flowMinWidth(10)
                    .flowMaxWidth(60)
                    .flowMapType('curved')
                    .flowDonuts(false)
                    // .flowColor("#72bb6f")
                    .flowColor((d) => {
                        if (!d.target || !d.target.change) {
                            console.log(d)
                            return '#999999';
                        }
                        return colorFunction(parseChangeToPct(d.target.change))
                    })
                    .flowOpacity(0.9)
                    .flowArrows(false)
                    .flowOutlines(true)
                    .flowColorGradient(false)
                    .flowWidthGradient(true)
                    .flowTopLocations(0)
                    .flowStack(false)
                    //flowWidthGradient(true) //flowColor(()=>) //flowArrowDirection
                    //.flowRegionColors(["#bbd7ee", "#c7e3c6"]) // exporter, importers only works when polygons have same codes as nodes

                    // legend
                    .legend({
                        x: width - 210,
                        y: 2,
                        boxPadding: 10,
                        title: "Freight carried",
                        subtitle: "(tonnes)",
                        flowWidthLegend: {
                            marginTop: -10,
                            values: [3, 500, 2700],
                            labelFormatter: (value) => spaceAsThousandSeparator(value * 1000)
                        },
                        donutSizeLegend: { title: "Location total" },
                        flowColorLegend: {
                            marginTop: 50,
                            title: "Change vs 2022 (%)",
                            items: [

                                { color: colorFunction(-21), label: "≤ -20 (decrease)" },
                                { color: colorFunction(-15), label: "< -10" },
                                { color: colorFunction(-7), label: "< -5" },
                                { color: colorFunction(-2), label: "< 0" },
                                { color: colorFunction(2.5), label: "> 0" },
                                { color: colorFunction(8.7), label: "≥ 5 (increase)" }

                            ].reverse()
                        },
                        regionColorLegend: {
                            title: "Region color",
                            marginTop: 20,
                            labels: ["a", "b"]
                        },
                        boxOpacity: 1,
                        histogram: false
                    })

                    //labels
                    .labels({
                        labels: regionLabels,
                        shadows: true,
                        values: true,
                        valuesFormatter: valuesLabelFormatter
                    })

                    .tooltip({
                        textFunction: tooltipFunction
                    })

                    .footnote(
                        "Freight includes both loaded and unloaded. Administrative boundaries: ©EuroGeographics ©UN-FAO @OpenStreetMap"
                    )

                    // zoom min/max
                    .zoomExtent([0.6, 10])
                    .zoomButtons(true)

                    .callback(() => {
                        // set fill of regions
                        const countries = d3.selectAll("#air-freight-map .em-worldrg path");
                        countries.style("fill", (d) => {
                            for (const [regionName, codes] of Object.entries(regions)) {
                                if (codes.includes(d.id)) {
                                    return regionColors[regionName];
                                }
                            }
                        });
                        // raise labels (fixed in next version of estatmap)
                        const labels = d3.selectAll("#em-labels");
                        labels.raise();
                    })
                    .build();
            })
            .catch(err => console.error(err));

    </script>
</body>

</html>