<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        @import url('./air-freight.css');
    </style>
</head>

<body style="margin:0">
    <svg id="air-freight-map"></svg>

    <svg style='display:none;'>
        <!-- used for country borders -->
        <defs>
            <filter id="blur-effect" x="-50%" y="-50%" width="150%" height="150%">
                <feGaussianBlur in="SourceGraphic" stdDeviation=".6" />
            </filter>
        </defs>
    </svg>
    <script src="../../../build/eurostatmap.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="./regionLabels.js"></script>
    <script src="./regions.js"></script>
    <script>
        fetch('./airFreightGraph.json')
            .then(r => r.json())
            .then(graphData => {
                console.log('Loaded freight data:', graphData);

                const regionColors = {
                    "north america": "#fbead7", // pale sand
                    "central america and caribbean": "#fcf3d6", // light cream
                    "south america": "#d8f0ea", // pale turquoise
                    "north africa": "#fce2da", // warm blush
                    "rest of africa": "#dee6ea", // misty blue-grey
                    "western asia": "#fdeacc", // peach tint
                    "southern asia": "#f9dede", // rose tint
                    "central asia": "#fdf3d9", // pale yellow
                    "eastern asia": "#e6f0ff", // pale lavender-blue (cooler)
                    ASEAN: "#e0f8f0", // pale mint-green (warmer)
                    "australasia, s.sea is. & antarctica": "#e5ecf0", // fog grey-blue
                    EU: "#dde5f0", // very light slate
                    "europe except eu": "#E8EEFA", // faint blue-grey
                    "eastern africa": "#E6F4EA"
                }

                const width = 900

                const worldProjection = d3
                    .geoAzimuthalEquidistant()
                    .rotate([0, 0])
                    .scale(200)
                    .translate([width / 2.4, width / 2.3])

                const valuesLabelFormatter = (d) => d3.format('.2s')(d * 1000)

                const colorFunction = d3.scaleDiverging()
                    .domain([-1, 0, 1])
                    .interpolator(d3.interpolateRdBu);

                const spaceAsThousandSeparator = function (number) {
                    return number.toLocaleString('en').replace(/,/gi, ' ')
                }
                const tooltipFunction = function (link, map) {
                    const buf = []
                    const statData = map.statData()
                    const unit = statData.unitText() || ''

                    // Header with region name and ID
                    const title = `${link.source.name || link.source.id} to ${link.target.name || link.target.id}`
                    buf.push(`
                        <div class="em-tooltip-bar">
                            <b>${title}</b>
                        </div>
                    `)

                    // Value
                    buf.push(`<div class='em-tooltip-text'>
                        <table class="em-tooltip-table">
                            <tbody>
                                <tr><td>${spaceAsThousandSeparator(link.value * 1000)} tonnes</td></tr>
                                <tr><td>Change: ${link.target.change}</td></tr>
                            </tbody>
                        </table> 
                    </div>`)

                    return buf.join('')
                }

                const map = eurostatmap
                    .map("flow")
                    .svgId("air-freight-map")
                    .width(width)
                    .height(width / 1.5)
                    .title("Air freight")
                    .subtitle(
                        "Transport of freight and mail from the EU to outside the EU, 2023"
                    )

                    //projection
                    .projectionFunction(worldProjection)

                    //geometries
                    .geo("WORLD")
                    .proj("4326")
                    .scale("60M")

                    // flow settings
                    .flowGraph(graphData)
                    .flowMinWidth(4)
                    .flowMapType('curved')
                    .flowDonuts(false)
                    // .flowColor("#72bb6f")
                    .flowColor((d) => {
                        console.log(d)
                        const change = parseFloat(d.target.change)
                        return colorFunction(change)
                    })
                    .flowOpacity(0.8)
                    .flowArrows(false)
                    .flowOutlines(true)
                    .flowGradient(true)
                    .flowTopLocations(0)
                    //flowWidthGradient(true) //flowColor(()=>) //flowArrowDirection
                    //.flowOverlayColors(["#bbd7ee", "#c7e3c6"]) // exporter, importers only works when polygons have same codes as nodes

                    // legend
                    .legend({
                        x: width - 150,
                        y: 0,
                        boxPadding: 10,
                        title: "Freight carried",
                        subtitle: "(thousand tonnes)",
                        flowWidthLegend: {
                            marginTop: -10,
                            values: [3, 500, 2600],
                            labelFormatter: (value) => value * 1000 //NOT WORKING
                        },
                        donutSizeLegend: { title: "Location total" },
                        flowColorLegend: {
                            title: "Freight line color",
                            items: [
                                { color: colorFunction(-1), label: "Decreased significantly" },
                                { color: colorFunction(0), label: "No change" },
                                { color: colorFunction(1), label: "Increased significantly" },
                            ]
                        },
                        regionColorLegend: {
                            title: "Region color",
                            marginTop: 20,
                            labels: ["a", "b"]
                        },
                        boxOpacity: 1,
                        histogram: false
                    })

                    //labels
                    .labels({
                        labels: regionLabels,
                        shadows: true,
                        values: true,
                        valuesFormatter: valuesLabelFormatter
                    })

                    .tooltip({
                        textFunction: tooltipFunction
                    })

                    .footnote(
                        "Freight includes both loaded and unloaded. Administrative boundaries: ©EuroGeographics ©UN-FAO @OpenStreetMap"
                    )

                    // zoom min/max
                    .zoomExtent([0.6, 10])
                    .zoomButtons(true)

                    .callback(() => {
                        // set fill of regions
                        const countries = d3.selectAll("#air-freight-map .em-worldrg path");
                        countries.style("fill", (d) => {
                            for (const [regionName, codes] of Object.entries(regions)) {
                                if (codes.includes(d.id)) {
                                    return regionColors[regionName];
                                }
                            }
                        });
                        // raise labels (fixed in next version of estatmap)
                        const labels = d3.selectAll("#em-labels");
                        labels.raise();
                    })
                    .build();
            })
            .catch(err => console.error(err));

    </script>
</body>

</html>