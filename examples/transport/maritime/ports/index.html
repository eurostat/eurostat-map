<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        @import url('./ports.css');
    </style>
</head>

<body style="margin:0">
    <svg id="ports-map"></svg>

    <svg style='display:none;'>
        <!-- used for country borders -->
        <defs>
            <filter id="blur-effect" x="-50%" y="-50%" width="150%" height="150%">
                <feGaussianBlur in="SourceGraphic" stdDeviation=".6" />
            </filter>
        </defs>
    </svg>
    <script src="../../../../build/eurostatmap.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/proj4"></script>
    <script src="./portsData.js"></script>

    <script id="'our-map">
        const portsWidth = 737;
        const portsHeight = 405;
        proj4.defs(
            "EPSG:3035",
            "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 " +
            "+ellps=GRS80 +units=m +no_defs +type=crs"
        )
        const to3035 = ([lon, lat]) => proj4("EPSG:4326", "EPSG:3035", [lon, lat])
        function indexByCode(portsData, valueKey = "tonnes_2024") {
            return Object.fromEntries(portsData.map((p) => [p.code, p[valueKey]]));
        }
        const getApproxCurrentGeoBbox = function () {
            const defaultPosition = { x: 4790000, y: 3420000 };
            const halfWidth = 0.5 * defaultPosition.z * portsWidth;
            const halfHeight = 0.5 * defaultPosition.z * portsHeight;
            return [
                defaultPosition.x - halfWidth,
                defaultPosition.y - halfHeight,
                defaultPosition.x + halfWidth,
                defaultPosition.y + halfHeight
            ];
        }
        const getBBOXAsGeoJSON = function (bb) {
            return {
                type: "Feature",
                geometry: {
                    type: "MultiPoint",
                    coordinates: [
                        [bb[0], bb[1]],
                        [bb[2], bb[3]]
                    ]
                }
            };
        }

        const portsProjection = d3
            .geoIdentity()
            .reflectY(true)
            .fitSize(
                [portsWidth, portsHeight],
                getBBOXAsGeoJSON(getApproxCurrentGeoBbox())
            )



        const portsSizeData = indexByCode([...portsData])
        const map = eurostatmap
            .map("ps")
            .svgId("ports-map")
            .nutsLevel(0)
            .psMinSize(3)
            .psMaxSize(50)
            .title("Freight handled by maritime ports")
            .subtitle("Both incoming and outgoing, 2024")
            .footnote(
                "Note: shows data for ports with at least 2 million tonnes of freight handled."
            )
            .legend({
                title: "Tonnes of freight",
                x: portsWidth - 150,
                y: 10,
                sizeLegend: {
                    values: [300000000, 100000000, 2000000],
                    labelFormatter: (l) => l / 1000000 + " million"
                }
            })
            .filterGeometriesFunction((geometries) => {
                //remove greenland to stop title overlap
                let nuts2json = geometries[0];
                let countries = nuts2json.objects.cntrg.geometries;
                countries = countries.filter((f) => {
                    if (f.properties.id !== "GL") return f;
                });
                nuts2json.objects.cntrg.geometries = countries;

                // add ports to centroids array
                let centroids = geometries[1];
                [...portsData].forEach((d) => {
                    let coords = to3035([d.lon, d.lat]);
                    let newCentroid = {
                        type: "Feature",
                        geometry: {
                            coordinates: coords,
                            type: "Point"
                        },
                        properties: {
                            centroid: portsProjection(coords),
                            id: d.code,
                            na: d.name
                        }
                    };
                    centroids.features.push(newCentroid);
                });
                return geometries;
            })
            //.insets("default")
            // add insets for canarias, reunion, guadeloupe, malta, martinique
            .zoomButtons(true)
            .build();

        map.statData("size").setData(portsSizeData);

    </script>
</body>

</html>