<!doctype html>
<html lang="en">

<head>
    <title>Air freight map</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        @import url('./air-freight.css');
    </style>
</head>

<body style="margin:0">

    <div>
        <button id="export-png-btn" type="button">Export map as PNG</button>
        <button id="export-svg-btn" type="button">Export map as SVG</button>
    </div>
    <svg id="air-freight-map"></svg>

    <svg style='display:none;'>
        <!-- used for country borders -->
        <defs>
            <filter id="blur-effect" x="-50%" y="-50%" width="150%" height="150%">
                <feGaussianBlur in="SourceGraphic" stdDeviation=".6" />
            </filter>
        </defs>
    </svg>
    <script src="../../eurostatmap.min.js"></script>
    <script src="../../d3.v7.min.js"></script>
    <script src="./regionLabels.js"></script>
    <script src="./regions.js"></script>
    <script src="./configs.js"></script>
    <script>

        const year = 2024
        const width = 1080
        const height = width / 1.7
        const worldProjection = d3
            .geoAzimuthalEquidistant()
            .rotate([-10, -10])
            .scale(200)
            .translate([width / 2.4, width / 2.6])


        const makeLegendItems = () =>
            airMapConfigs[year].freight.legend.labels
                .map((label, i) => ({
                    color: airMapConfigs[year].freight.colors[i],
                    label
                }))
                .reverse()

        fetch(`./airFreightGraph${year}.json`)
            .then(r => r.json())
            .then(graphData => {

                const greys = ['#D3D3D3', '#A9A9A9', '#808080', '#696969', '#36454F']; // Light Gray, Dark Gray: #808080, Dim Gray: #696969, Charcoal: #36454F
                const fourColorTheorem = [
                    "#388AE2", // blue
                    "#B09120", // yellow
                    "#33A033", // green
                    "#E04040"  // red
                ];
                const regionColors = {
                    "north america": fourColorTheorem[0],
                    "central america and caribbean": fourColorTheorem[1],
                    "south america": fourColorTheorem[2],
                    "eastern africa": fourColorTheorem[1],
                    "rest of africa": fourColorTheorem[2],
                    "western asia": fourColorTheorem[0],
                    "southern asia": fourColorTheorem[2],
                    "central asia": fourColorTheorem[1],
                    "eastern asia": fourColorTheorem[0],
                    "south eastern asia": fourColorTheorem[1],
                    "Oceania and southern polar regions": fourColorTheorem[2],
                    EU: '#003399',
                    "europe except eu": fourColorTheorem[2]
                }

                const truncateSI = d => {
                    const abs = Math.abs(d);

                    if (abs >= 1e9) return Math.floor(d / 1e9) + "B";
                    if (abs >= 1e6) return Math.floor(d / 1e6) + "M";
                    if (abs >= 1e3) return Math.floor(d / 1e3) + "k";
                    return d.toString();
                };

                const valuesLabelFormatter = truncateSI;

                const colorFunction = d3.scaleThreshold()
                    .domain(airMapConfigs[year].freight.breaks)   // ascending thresholds
                    .range(airMapConfigs[year].freight.colors);   // length = breaks.length + 1

                function parseChangeToPct(v) {
                    if (v == null) return NaN;
                    const s = String(v).trim();
                    const hasPct = s.includes('%');
                    let n = parseFloat(s.replace('%', ''));
                    if (!hasPct && Math.abs(n) <= 1) n *= 100; // interpret small decimals as fractions
                    return n;
                }

                const spaceAsThousandSeparator = function (number) {
                    return number.toLocaleString('en').replace(/,/gi, ' ')
                }
                const tooltipFunction = function (link, map) {
                    const buf = []
                    const statData = map.statData()
                    const unit = statData.unitText() || ''

                    // Header with region name and ID
                    const title = `${link.source.name || link.source.id} to ${link.target.name || link.target.id}`
                    buf.push(`
                        <div class="em-tooltip-bar">
                            <b>${title}</b>
                        </div>
                    `)

                    // Value
                    buf.push(`<div class='em-tooltip-text'>
                        <table class="em-tooltip-table">
                            <tbody>
                                <tr><td>Tonnes of freight: ${spaceAsThousandSeparator(link.value)}</td></tr>
                                <tr>
                            <td>
                                Change since ${year - 1}: 
                                <span
                                style="
                                    background:${colorFunction(parseChangeToPct(link.target.change))};
                                    color:${getContrastTextColor(colorFunction(parseChangeToPct(link.target.change)))};
                                    padding:2px 4px;
                                    border-radius:3px;
                                "
                                >
                                ${link.target.change}
                                </span>
                            </td>
                            </tr>
                            </tbody>
                        </table> 
                    </div>`)

                    return buf.join('')
                }

                // sort links by value descending
                graphData.links.sort((a, b) => b.value - a.value);

                const map = eurostatmap
                    .map("flow")
                    .svgId("air-freight-map")
                    .hoverColor('#ffc700')
                    .width(width)
                    .height(height)
                    .title("Air freight")
                    .subtitle(
                        `Transport of freight and mail from the EU to outside the EU, ${year}`
                    )

                    //static settings
                    .header(true)
                    .footer(true)
                    .zoomButtons(false)
                    .showEstatLogo(true)
                    .showEstatRibbon(true)
                    .logoPosition([2, height + 42])
                    .ribbonPosition([width - 180, height + 20])
                    .ribbonWidth(300)
                    .ribbonHeight(50)
                    //end static settings

                    //projection
                    .projectionFunction(worldProjection)

                    //geometries
                    .geo("WORLD")
                    .proj("4326")
                    .scale("60M")

                    // flow settings
                    .flowGraph(graphData)
                    .flowMinWidth(4)
                    .flowMaxWidth(40)
                    .flowMapType('curved')
                    .flowDonuts(false)
                    // .flowColor("#72bb6f")
                    .flowColor((d) => {
                        if (!d.target || !d.target.change) {
                            console.log(d)
                            return '#999999';
                        }
                        return colorFunction(parseChangeToPct(d.target.change))
                    })
                    .flowOpacity(1)
                    .flowArrows(false)
                    .flowArrowScale(0.7)
                    .flowOutlines(true)
                    .flowOutlineWidth(2)
                    .flowOutlineColor("white")
                    .flowColorGradient(false)
                    .flowWidthGradient(false)
                    .flowTopLocations(0)
                    .flowStack(false)
                    //only for when stacked
                    // .flowOrder((a, b) => {
                    //     console.log(a, b);
                    //     // Helper to extract ID whether link.source is object or string
                    //     const getId = (it) =>
                    //         typeof it === "object" ? it.id : it;

                    //     // Extract IDs for a
                    //     const aSrc = getId(a.link?.source);
                    //     const aTgt = getId(a.link?.target);

                    //     // Extract IDs for b
                    //     const bSrc = getId(b.link?.source);
                    //     const bTgt = getId(b.link?.target);

                    //     // Region membership helpers
                    //     const isCentralAsia = (id) => id === "ASI_C";
                    //     const isEasternAsia = (id) => id === "ASI_E";

                    //     // Does link involve either region?
                    //     const aInCentral = isCentralAsia(aSrc) || isCentralAsia(aTgt);
                    //     const bInCentral = isCentralAsia(bSrc) || isCentralAsia(bTgt);

                    //     const aInEastern = isEasternAsia(aSrc) || isEasternAsia(aTgt);
                    //     const bInEastern = isEasternAsia(bSrc) || isEasternAsia(bTgt);

                    //     // --- PRIORITY RULE ---
                    //     // Central Asia ABOVE Eastern Asia
                    //     if (aInCentral && !bInCentral) return -1;  // a above b
                    //     if (bInCentral && !aInCentral) return 1;   // b above a

                    //     if (aInEastern && !bInEastern) return -1;  // Eastern above rest
                    //     if (bInEastern && !aInEastern) return 1;

                    //     // --- FALLBACK ---
                    //     return a.otherY - b.otherY || b.width - a.width;
                    // }
                    // )

                    // legend
                    .legend({
                        x: width - 185,
                        y: 50,
                        boxPadding: 10,
                        title: "Freight carried",
                        subtitle: "(tonnes)",
                        flowWidthLegend: {
                            marginTop: -10,
                            values: airMapConfigs[year].freight.legend.sizeLegend.values,
                            labels: ['3 thousand', '1 million', '3 million']
                        },
                        flowColorLegend: {
                            marginTop: 50,
                            title: airMapConfigs[year].freight.legend.title,
                            items: makeLegendItems(year)
                        }
                    })

                    //labels
                    .labels({
                        labels: regionLabels,
                        shadows: true,
                        values: true,
                        valuesFormatter: valuesLabelFormatter
                    })

                    .tooltip({
                        textFunction: tooltipFunction
                    })

                    .footnote(
                        "Note: Freight includes both loaded and unloaded. &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <tspan style='font-style: italic;'>Source</tspan>: Eurostat (avia_goexcc)"
                    ).footnoteWrap(150)

                    // zoom min/max
                    .zoomExtent([0.6, 10])

                    .callback(() => {
                        // set fill of regions
                        const countries = d3.selectAll("#air-freight-map .em-worldrg path");
                        countries.style("fill", (d) => {
                            for (const [regionName, codes] of Object.entries(regions)) {
                                if (codes.includes(d.id)) {
                                    return regionColors[regionName];
                                }
                            }
                        });
                        // raise labels (fixed in next version of estatmap)
                        const labels = d3.selectAll("#em-labels");
                        labels.raise();

                        //add cartography text
                        // --- REMOVE if it already exists ---
                        d3.select("#air-freight-map #em-footnote-2").remove();

                        d3.selectAll("#air-freight-map")
                            .append('text')
                            .attr('x', width - 315)
                            .attr('y', height + 95)
                            .attr('class', 'em-footnote').attr('id', 'em-footnote-2')
                            .append('tspan')
                            .html('Cartography: GISCO, Boundaries: ©EuroGeographics ©OSM');
                    })
                    .build();

                const exportBtnPNG = document.getElementById("export-png-btn");
                exportBtnPNG.addEventListener("click", function () {
                    map.exportMapToPNG(1080, 752.4941184099982);
                });

                const exportBtnSVG = document.getElementById("export-svg-btn");
                exportBtnSVG.addEventListener("click", function () {
                    map.exportMapToSVG();
                });
            })
            .catch(err => console.error(err));


        function getContrastTextColor(hex) {
            hex = hex.replace('#', '');
            if (hex.length === 3) {
                hex = hex.split('').map(c => c + c).join('');
            }

            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);

            // Perceived luminance
            const luminance = 0.299 * r + 0.587 * g + 0.114 * b;

            return luminance > 140 ? 'black' : 'white';
        }
    </script>
</body>

</html>