<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            .border {
                fill: none;
                stroke: black;
                stroke-width: 0.5px;
                stroke-linejoin: round;
            }
        </style>
    </head>

    <body>
        <svg id="map"></svg>
        <script src="../build/eurostatmap.js"></script>
        <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

        <script>
            const width = 600
            const height = 600

            fetch(`./geometries/spain_borders.json`)
                .then((response) => response.json()) // Parse response as JSON
                .then((bordersTopoJSON) => {
                    fetch(`./geometries/spain-municipalities.topojson.json`)
                        .then((response) => response.json()) // Parse response as JSON
                        .then((topoJSON) => {
                            const geoJSON = topojson.feature(topoJSON, topoJSON.objects[Object.keys(topoJSON.objects)[0]])
                            const bordersGeoJSON = topojson.feature(
                                bordersTopoJSON,
                                bordersTopoJSON.objects[Object.keys(bordersTopoJSON.objects)[0]]
                            )

                            // add ids to feature properties to be able to link stat data to them
                            geoJSON.features.forEach((feature) => {
                                feature.properties.id = feature.id
                            })

                            let statisticalData = createProgressiveIdValueMap(geoJSON.features)

                            // projection
                            const projection = d3.geoAzimuthalEqualArea().rotate([-1, -40.55]).scale(3000)

                            const map = eurostatmap
                                .map('choropleth')
                                .geoCenter([2, 47])
                                .zoomExtent([1, 10])
                                .width(width)
                                .height(height)
                                .title('Custom geometries test')
                                .projectionFunction(projection)
                                .geometries([
                                    { id: 'regions', regions: true, features: geoJSON.features, class: (feature) => 'region' },
                                    { id: 'borders', features: bordersGeoJSON.features, class: (feature) => 'border' },
                                ])

                            map.statData().setData(statisticalData)

                            map.build()
                        })
                        .catch((error) => console.error('Error loading TopoJSON:', error))
                })

            function createProgressiveIdValueMap(features) {
                const idValueMap = {}
                const step = 1000 / features.length // Calculate the step for gradual increase

                features.forEach((feature, index) => {
                    const id = feature.properties.id
                    const value = Math.floor(step * (index + 1)) // Increase value progressively
                    idValueMap[id] = value
                })

                return idValueMap
            }
        </script>
    </body>
</html>
